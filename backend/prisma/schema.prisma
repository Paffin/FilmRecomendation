generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(version: "0.5.1")]
}

enum MediaType {
  movie
  tv
  anime
  cartoon
}

enum TitleSource {
  onboarding
  search
  recommendation
  manual
}

enum TitleStatus {
  planned
  watching
  watched
  dropped
}

enum FeedbackContext {
  recommendation_card
  title_page
  history
  onboarding
}

enum CatalogSnapshotKind {
  trending
  popular
}

model RecommendationExperiment {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  isActive    Boolean  @default(true)
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments UserExperimentAssignment[]
}

model UserExperimentAssignment {
  id           String   @id @default(uuid())
  userId       String
  experimentId String
  variantKey   String
  assignedAt   DateTime @default(now())
  sticky       Boolean  @default(true)

  user       User                   @relation(fields: [userId], references: [id])
  experiment RecommendationExperiment @relation(fields: [experimentId], references: [id])

  @@unique([userId, experimentId])
  @@index([experimentId])
}

model User {
  id                   String   @id @default(uuid())
  email                String   @unique
  passwordHash         String
  displayName          String
  onboardingCompleted  Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  userTitleStates        UserTitleState[]
  feedbackEvents         FeedbackEvent[]
  recommendationSessions RecommendationSession[]
  tasteProfile           UserTasteProfile?
  groupTasteProfiles     GroupTasteProfile[]
  refreshTokens          RefreshToken[]
  experimentAssignments  UserExperimentAssignment[]
}

model Title {
  id               String   @id @default(uuid())
  tmdbId           Int      @unique
  imdbId           String?
  mediaType        MediaType
  originalTitle    String
  russianTitle     String
  overview         String
  posterPath       String?
  backdropPath     String?
  releaseDate      DateTime?
  runtime          Int?
  tmdbRating       Float?
  genres           String[]
  countries        String[]
  originalLanguage String
  rawTmdbJson      Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  userTitleStates  UserTitleState[]
  feedbackEvents   FeedbackEvent[]
  recommendationItems RecommendationItem[]
  embedding        TitleEmbedding?
}

model TitleEmbedding {
  titleId   String   @id
  embedding Float[]
  model     String
  language  String?
  updatedAt DateTime @updatedAt

  title Title @relation(fields: [titleId], references: [id])
}

model UserTitleState {
  id                String      @id @default(uuid())
  userId            String
  titleId           String
  status            TitleStatus
  source            TitleSource
  liked             Boolean     @default(false)
  disliked          Boolean     @default(false)
  rating            Int?
  lastInteractionAt DateTime    @default(now())

  user   User  @relation(fields: [userId], references: [id])
  title  Title @relation(fields: [titleId], references: [id])

  @@unique([userId, titleId])
  @@index([userId, status])
}

model FeedbackEvent {
  id                      String       @id @default(uuid())
  userId                  String
  titleId                 String
  value                   Int
  context                 FeedbackContext
  recommendationSessionId String?
  createdAt               DateTime @default(now())

  user   User  @relation(fields: [userId], references: [id])
  title  Title @relation(fields: [titleId], references: [id])
  recommendationSession RecommendationSession? @relation(fields: [recommendationSessionId], references: [id])

  @@index([userId, createdAt])
}

model RecommendationSession {
  id        String    @id @default(uuid())
  userId    String
  context   Json
  createdAt DateTime  @default(now())

  user    User   @relation(fields: [userId], references: [id])
  items   RecommendationItem[]
  feedbackEvents FeedbackEvent[]
}

model RecommendationItem {
  id        String   @id @default(uuid())
  sessionId String
  titleId   String
  rank      Int
  score     Float
  signals   Json
  replaced  Boolean  @default(false)
  createdAt DateTime @default(now())

  session RecommendationSession @relation(fields: [sessionId], references: [id])
  title   Title                 @relation(fields: [titleId], references: [id])

  @@index([sessionId])
  @@unique([sessionId, titleId])
}

model UserTasteProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  data      Json
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model GroupTasteProfile {
  id          String   @id @default(uuid())
  userId      String
  companyType String
  data        Json
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, companyType])
  @@index([userId])
}

model CatalogSnapshot {
  id           String             @id @default(uuid())
  tmdbId       Int
  mediaType    MediaType
  kind         CatalogSnapshotKind
  score        Float?
  snapshotDate DateTime           @default(now())
  createdAt    DateTime           @default(now())

  @@index([kind, snapshotDate])
  @@index([mediaType, kind, snapshotDate])
  @@index([tmdbId, mediaType])
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String   @unique
  jti        String
  familyId   String
  userAgent  String?
  ip         String?
  expiresAt  DateTime
  revokedAt  DateTime?
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([familyId])
  @@index([userId, familyId])
  @@index([expiresAt])
}
